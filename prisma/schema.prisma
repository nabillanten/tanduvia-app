// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// --- ENUMS ---
enum Role {
  super_admin
  petugas
  ahli_gizi
  ibu
}

enum Gender {
  L
  P
}

enum JenisIndeks {
  BB_U
  TB_U
  BB_TB
  IMT_U
}

enum StatusPublikasi {
  pending
  published
  rejected
}

enum StatusGizi {
  sangat_pendek
  pendek
  normal
  tinggi
  bb_sangat_kurang
  bb_kurang
  bb_normal
  risiko_bb_lebih
}

// --- MODELS ---

model Posyandu {
  id            String   @id @default(uuid()) 
  nama_posyandu String
  alamat        String?  
  created_at    DateTime @default(now())
  
  users         User[]
  anak          Anak[]
  
  @@map("posyandu")
}

model User {
  id            String   @id @default(uuid())
  posyandu_id   String?
  
  nama_lengkap  String
  username      String   @unique 
  password      String
  role          Role
  no_telepon    String?
  is_active     Boolean  @default(true)
  created_at    DateTime @default(now())

  posyandu      Posyandu? @relation(fields: [posyandu_id], references: [id])
  anak          Anak[]    @relation("IbuAnak")
  pemeriksaan   Pemeriksaan[] 
  rekomendasi   RekomendasiGizi[]

  @@map("users")
}

model Anak {
  id            String   @id @default(uuid())
  ibu_id        String
  posyandu_id   String
  
  rfid_tag      String   @unique
  nik           String?  @unique
  nama_anak     String
  tempat_lahir  String?
  tanggal_lahir DateTime @db.Date 
  jenis_kelamin Gender
  
  bb_lahir      Decimal? @db.Decimal(5, 2)
  tb_lahir      Decimal? @db.Decimal(5, 1)
  
  is_active     Boolean  @default(true)
  created_at    DateTime @default(now())

  ibu           User     @relation("IbuAnak", fields: [ibu_id], references: [id], onDelete: Cascade)
  posyandu      Posyandu @relation(fields: [posyandu_id], references: [id])
  pemeriksaan   Pemeriksaan[]

  @@map("anak")
}

// Standar Antropometri tetap Int (Autoincrement) karena data referensi statis
model StandarAntropometri {
  id              Int         @id @default(autoincrement())
  jenis_indeks    JenisIndeks
  jenis_kelamin   Gender
  umur_bulan      Int
  
  batas_min_3_sd  Decimal?    @db.Decimal(5, 2)
  batas_min_2_sd  Decimal?    @db.Decimal(5, 2)
  batas_min_1_sd  Decimal?    @db.Decimal(5, 2)
  median          Decimal?    @db.Decimal(5, 2)
  batas_plus_1_sd Decimal?    @db.Decimal(5, 2)
  batas_plus_2_sd Decimal?    @db.Decimal(5, 2)
  batas_plus_3_sd Decimal?    @db.Decimal(5, 2)

  @@map("standar_antropometri")
}

model Pemeriksaan {
  id            String   @id @default(uuid())
  anak_id       String
  petugas_id    String
  
  tanggal_ukur  DateTime @db.Date
  usia_bulan    Int
  
  berat_badan   Decimal  @db.Decimal(5, 2)
  tinggi_badan  Decimal  @db.Decimal(5, 1)
  
  status_bb_u   StatusGizi? 
  status_tb_u   StatusGizi?
  
  status_bb_tb  String?      
  status_imt_u  String?      
  
  catatan       String?
  created_at    DateTime @default(now())

  anak          Anak     @relation(fields: [anak_id], references: [id], onDelete: Cascade)
  petugas       User     @relation(fields: [petugas_id], references: [id])

  @@map("pemeriksaan")
}

model RekomendasiGizi {
  id             String        @id @default(uuid())
  ahli_gizi_id   String
  
  judul          String
  deskripsi      String        @db.Text
  
  usia_min       Int           
  usia_max       Int           
  
  jenis_indeks   JenisIndeks   
  target_status  StatusGizi    
  
  status         StatusPublikasi @default(pending)
  catatan_admin  String?         @db.Text 
  
  icon_url       String?
  created_at     DateTime      @default(now())

  ahli_gizi      User          @relation(fields: [ahli_gizi_id], references: [id], onDelete: Cascade)
  items          RekomendasiItem[]

  @@map("rekomendasi_gizi")
}

model RekomendasiItem {
  id             String          @id @default(uuid())
  rekomendasi_id String
  
  nama_makanan   String
  
  rekomendasi    RekomendasiGizi @relation(fields: [rekomendasi_id], references: [id], onDelete: Cascade)

  @@map("rekomendasi_item")
}